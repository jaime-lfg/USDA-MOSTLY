<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>USDA FOB Produce Prices</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <style>
    :root {
      --bg-primary:#0d1117;--bg-secondary:#161b22;--bg-card:#21262d;--bg-hover:#30363d;
      --text-primary:#f0f6fc;--text-secondary:#8b949e;--text-muted:#6e7681;
      --green:#3fb950;--green-dim:rgba(63,185,80,.15);
      --red:#f85149;--red-dim:rgba(248,81,73,.15);
      --blue:#58a6ff;--blue-dim:rgba(88,166,255,.15);
      --border:#30363d;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary)}
    .container{max-width:1400px;margin:auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding-bottom:20px;margin-bottom:24px}
    .logo{display:flex;gap:12px;align-items:center}
    .logo-icon{font-size:32px}
    .logo-text h1{font-size:1.4rem}
    .logo-text span{font-size:.8rem;color:var(--text-muted)}
    .season-badge{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:20px;border:1px solid var(--blue);background:var(--blue-dim);color:var(--blue)}
    .commodity-tabs{display:flex;gap:8px;margin-bottom:24px}
    .tab{padding:10px 18px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-secondary);cursor:pointer}
    .tab.active{border-color:var(--green);color:var(--green);background:var(--green-dim)}
    .main-layout{display:grid;grid-template-columns:1fr 300px;gap:24px}
    .chart-section{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:24px}
    .chart-container{height:420px;margin-top:16px;position:relative}
    .no-data{position:absolute;inset:0;display:none;align-items:center;justify-content:center;color:var(--text-muted)}
    .no-data.show{display:flex}
    .price-value{font-size:2.8rem;font-weight:700}
    .price-change{margin-left:12px}
    .sidebar{display:flex;flex-direction:column;gap:16px}
    .price-card{border:1px solid var(--border);border-radius:10px;padding:16px}
    .price-card.active{border-color:var(--green);background:linear-gradient(135deg,var(--green-dim),transparent)}
    footer{margin-top:32px;border-top:1px solid var(--border);padding-top:20px;display:flex;justify-content:space-between}
  </style>
</head>

<body>
<div class="container">

<header>
  <div class="logo">
    <span class="logo-icon">ðŸ¥¬</span>
    <div class="logo-text">
      <h1>FOB Produce Prices</h1>
      <span>USDA Market News â€¢ MOSTLY Avg</span>
    </div>
  </div>
  <div class="season-badge" id="seasonLabel">Auto</div>
</header>

<div class="commodity-tabs">
  <button class="tab active" data-commodity="iceberg">Iceberg</button>
  <button class="tab" data-commodity="romaine">Romaine</button>
  <button class="tab" data-commodity="hearts">Romaine Hearts</button>
  <button class="tab" data-commodity="broccoli">Broccoli</button>
  <button class="tab" data-commodity="cauliflower">Cauliflower</button>
  <button class="tab" data-commodity="celery">Celery</button>
</div>

<div class="main-layout">
  <div class="chart-section">
    <h2 id="commodityName">Iceberg</h2>
    <div>
      <span class="price-value" id="currentPrice">â€”</span>
      <span class="price-change" id="priceChange">â€”</span>
    </div>
    <div class="chart-container">
      <canvas id="mainChart"></canvas>
      <div class="no-data" id="noData">No matching rows yet</div>
    </div>
  </div>

  <div class="sidebar">
    <div class="price-card active" data-commodity="iceberg">
      <strong>Iceberg</strong>
      <div id="price-iceberg">â€”</div>
    </div>
    <div class="price-card" data-commodity="romaine">
      <strong>Romaine</strong>
      <div id="price-romaine">â€”</div>
    </div>
    <div class="price-card" data-commodity="hearts">
      <strong>Hearts</strong>
      <div id="price-hearts">â€”</div>
    </div>
  </div>
</div>

<footer>
  <div>USDA AMS FOB Review</div>
  <div id="lastSync">â€”</div>
</footer>

</div>

<script>
const SHEET_URL =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vQVa4C--Jhg96w7_A0vqkTJouxLCvHOn2AT49foGzmdjcvU9DIn9a0QoEADzQ6SCDmqmuHNRZcJVmgm/pub?gid=1273956115&single=true&output=csv';

let state={commodity:'iceberg',data:{}},chart=null;

function csvParseLine(l){
  let r=[],c='',q=false;
  for(let i=0;i<l.length;i++){
    if(l[i]=='"'){q=!q}
    else if(l[i]==','&&!q){r.push(c);c=''}
    else c+=l[i];
  }
  r.push(c);return r;
}

function normalizeDate(d){
  if(d.includes('/')){
    let [m,dd,y]=d.split('/');
    return `${y}-${m.padStart(2,'0')}-${dd.padStart(2,'0')}`;
  }
  return d;
}

function mapCommodity(c,p){
  c=c.toUpperCase();p=p.toUpperCase();
  if(c==='LETTUCE, ICEBERG')return'iceberg';
  if(c==='LETTUCE, ROMAINE'&&p.includes('HEART'))return'hearts';
  if(c==='LETTUCE, ROMAINE')return'romaine';
  if(c==='BROCCOLI')return'broccoli';
  if(c==='CAULIFLOWER')return'cauliflower';
  if(c==='CELERY')return'celery';
  return null;
}

async function loadData(){
  const t=await fetch(SHEET_URL).then(r=>r.text());
  const l=t.trim().split('\n');
  const h=csvParseLine(l[0]).map(x=>x.toLowerCase());
  const i=d=>h.indexOf(d);
  let data={};

  for(let i2=1;i2<l.length;i2++){
    const r=csvParseLine(l[i2]);
    const ckey=mapCommodity(r[i('commodity')],r[i('package')]);
    if(!ckey)continue;
    const avg=parseFloat(r[i('mostly avg')]);
    if(!avg)continue;
    data[ckey]??=[];
    data[ckey].push({date:normalizeDate(r[i('date')]),avg});
  }
  state.data=data;
}

function render(){
  const d=state.data[state.commodity]||[];
  if(chart)chart.destroy();
  if(!d.length){document.getElementById('noData').classList.add('show');return;}
  document.getElementById('noData').classList.remove('show');
  document.getElementById('currentPrice').textContent=`$${d.at(-1).avg.toFixed(2)}`;

  chart=new Chart(document.getElementById('mainChart'),{
    type:'line',
    data:{labels:d.map(x=>x.date),datasets:[{data:d.map(x=>x.avg),borderColor:'#3fb950',fill:false,pointRadius:d.length===1?4:0}]},
    options:{responsive:true,maintainAspectRatio:false}
  });
}

document.querySelectorAll('.tab').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    b.classList.add('active');
    state.commodity=b.dataset.commodity;
    render();
  };
});

loadData().then(render);
</script>

</body>
</html>
