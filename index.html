<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>USDA FOB Produce Prices</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

<style>
body {
  background:#0d1117;
  color:#f0f6fc;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}
.container { max-width:1200px; margin:20px auto; }
select, button { background:#21262d; color:#f0f6fc; border:1px solid #30363d; padding:6px 10px; }
canvas { background:#161b22; border-radius:8px; }
</style>
</head>

<body>
<div class="container">
  <h2>USDA FOB Produce Prices</h2>

  <label>Region:
    <select id="regionSelect"></select>
  </label>

  <canvas id="chart" height="400"></canvas>
</div>

<script>
/* =========================
   REGIONS
========================= */

const VEG_REGIONS = {
  salinas: { name: 'Salinas-Watsonville' },
  imperial: { name: 'Imperial/Coachella' },
  yuma: { name: 'Yuma' },
  'western-arizona': { name: 'Western Arizona' },
  'santa-maria': { name: 'Santa Maria' }
};

/* =========================
   STATE
========================= */

let state = {
  region: 'auto',
  data: {}
};

let chart;

/* =========================
   DATE PARSING (ROBUST)
========================= */

function normalizeDate(v) {
  if (!v) return null;

  if (v instanceof Date) return v;

  if (typeof v === 'string') {
    const g = v.match(/Date\((\d+),(\d+),(\d+)\)/);
    if (g) return new Date(Date.UTC(+g[1], +g[2], +g[3]));
    const d = new Date(v);
    if (!isNaN(d)) return d;
  }

  if (typeof v === 'number') {
    return new Date((v - 25569) * 86400 * 1000);
  }

  return null;
}

/* =========================
   DATA FETCH
========================= */

const SHEET_URL =
  'https://docs.google.com/spreadsheets/d/1vHq6C9kgA7TANUfR6VBzPVRn6Zr6PTjhawjKNy2pIsY/pub?gid=601485202&single=true&output=csv';

async function fetchData() {
  const jsonUrl = SHEET_URL
    .replace('/pub?', '/gviz/tq?tqx=out:json&')
    .replace('&output=csv', '');

  const res = await fetch(jsonUrl);
  const text = await res.text();
  const json = JSON.parse(text.match(/setResponse\((.*)\)/s)[1]);

  const out = {};
  json.table.rows.forEach(r => {
    const c = r.c;
    if (!c) return;

    const d = normalizeDate(c[0]?.v);
    const region = String(c[1]?.v || '').toUpperCase();
    const avg = Number(c[6]?.v);

    if (!d || !avg) return;

    let key = null;
    if (region.includes('WESTERN ARIZONA')) key = 'western-arizona';
    else if (region.includes('SALINAS')) key = 'salinas';
    else if (region.includes('IMPERIAL') || region.includes('COACHELLA')) key = 'imperial';
    else if (region.includes('YUMA')) key = 'yuma';
    else if (region.includes('SANTA MARIA') || region.includes('OXNARD')) key = 'santa-maria';

    if (!key) return;

    out[key] ??= [];
    out[key].push({ x: d, y: avg });
  });

  Object.values(out).forEach(arr =>
    arr.sort((a,b)=>a.x-b.x)
  );

  return out;
}

/* =========================
   REGION FALLBACK
========================= */

function getSeries(region) {
  if (region !== 'auto' && state.data[region]?.length) {
    return state.data[region];
  }

  let best = [];
  for (const r in state.data) {
    if (!best.length || state.data[r].at(-1)?.x > best.at(-1)?.x) {
      best = state.data[r];
    }
  }
  return best;
}

/* =========================
   CHART
========================= */

function render() {
  const data = getSeries(state.region);

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById('chart'), {
    type: 'line',
    data: {
      datasets: [{
        label: 'Mostly Avg',
        data,
        borderColor: '#3fb950',
        tension: 0.3,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { type: 'time', time: { unit: 'week' } },
        y: { ticks: { callback:v=>`$${v}` } }
      },
      plugins: {
        tooltip: {
          callbacks: {
            title(items) {
              const d = new Date(items[0].parsed.x);
              return d.toDateString();
            }
          }
        }
      }
    }
  });
}

/* =========================
   UI
========================= */

function populateRegions() {
  const sel = document.getElementById('regionSelect');
  sel.innerHTML = `<option value="auto">Auto (latest data)</option>`;
  Object.entries(VEG_REGIONS).forEach(([k,v])=>{
    sel.innerHTML += `<option value="${k}">${v.name}</option>`;
  });
  sel.onchange = e => { state.region = e.target.value; render(); };
}

/* =========================
   INIT
========================= */

(async function init() {
  state.data = await fetchData();
  populateRegions();
  render();
})();
</script>
</body>
</html>
