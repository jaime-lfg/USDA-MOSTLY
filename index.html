<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDA FOB Produce Prices</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #21262d;
            --bg-hover: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --green: #3fb950;
            --green-dim: rgba(63, 185, 80, 0.15);
            --red: #f85149;
            --red-dim: rgba(248, 81, 73, 0.15);
            --blue: #58a6ff;
            --blue-dim: rgba(88, 166, 255, 0.15);
            --orange: #d29922;
            --orange-dim: rgba(210, 153, 34, 0.15);
            --border: #30363d;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { font-size: 32px; }
        .logo-text h1 { font-size: 1.4rem; font-weight: 600; }
        .logo-text span { color: var(--text-muted); font-size: 0.8rem; }
        .season-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--blue-dim);
            border: 1px solid var(--blue);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--blue);
            font-weight: 500;
        }
        .season-badge .dot {
            width: 8px; height: 8px;
            background: var(--blue);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Section Toggle */
        .section-toggle {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 10px;
            width: fit-content;
        }
        .section-btn {
            padding: 10px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-btn:hover { color: var(--text-primary); }
        .section-btn.active { background: var(--bg-hover); color: var(--text-primary); }
        .section-btn .icon { font-size: 1.1rem; }
        
        .commodity-tabs { display: flex; gap: 6px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab {
            padding: 10px 18px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .tab:hover { background: var(--bg-hover); color: var(--text-primary); }
        .tab.active.vegetable { background: var(--green-dim); border-color: var(--green); color: var(--green); }
        .tab.active.onion { background: var(--orange-dim); border-color: var(--orange); color: var(--orange); }
        
        .main-layout { display: grid; grid-template-columns: 1fr 300px; gap: 24px; }
        @media (max-width: 1024px) { .main-layout { grid-template-columns: 1fr; } }
        .chart-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .price-display h2 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shipping-point {
            font-size: 0.75rem;
            padding: 3px 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            color: var(--text-muted);
        }
        .price-row { display: flex; align-items: baseline; gap: 16px; flex-wrap: wrap; }
        .price-value {
            font-size: 2.8rem;
            font-weight: 700;
            letter-spacing: -2px;
        }
        .price-value.no-data {
            font-size: 1.8rem;
            color: var(--text-muted);
        }
        .price-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .price-change.up { background: var(--green-dim); color: var(--green); }
        .price-change.down { background: var(--red-dim); color: var(--red); }
        .price-change.flat { background: var(--bg-hover); color: var(--text-secondary); }
        .price-meta { color: var(--text-muted); font-size: 0.8rem; margin-top: 6px; }
        .time-controls { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .time-range {
            display: flex;
            background: var(--bg-card);
            border-radius: 8px;
            padding: 3px;
            gap: 2px;
        }
        .time-btn {
            padding: 6px 14px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .time-btn:hover { color: var(--text-primary); background: var(--bg-hover); }
        .time-btn.active { background: var(--bg-hover); color: var(--text-primary); }
        .region-toggle { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-muted); }
        .region-toggle select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            color: var(--text-primary);
            font-size: 0.75rem;
            cursor: pointer;
        }
        .chart-container { position: relative; height: 400px; margin-top: 16px; }
        
        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 16px; }
        .sidebar-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 4px;
            margin-top: 8px;
        }
        .sidebar-section-title:first-child { margin-top: 0; }
        
        .price-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .price-card:hover { border-color: var(--text-muted); transform: translateY(-1px); }
        .price-card.active.vegetable { border-color: var(--green); background: linear-gradient(135deg, var(--green-dim), transparent); }
        .price-card.active.onion { border-color: var(--orange); background: linear-gradient(135deg, var(--orange-dim), transparent); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-title { font-size: 0.85rem; font-weight: 600; }
        .card-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
        .card-badge.up { background: var(--green-dim); color: var(--green); }
        .card-badge.down { background: var(--red-dim); color: var(--red); }
        .card-badge.flat { background: var(--bg-hover); color: var(--text-muted); }
        .card-price { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
        .card-range { font-size: 0.75rem; color: var(--text-muted); }
        .card-sparkline { height: 40px; max-height: 40px; margin-top: 12px; overflow: hidden; }
        
        .market-stats {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
        }
        .stats-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: var(--text-secondary); }
        .stat-value { font-weight: 600; }
        footer {
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        .footer-text { font-size: 0.75rem; color: var(--text-muted); }
        .footer-text a { color: var(--blue); text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <span class="logo-icon">ðŸ¥¬</span>
                <div class="logo-text">
                    <h1>FOB Produce Prices</h1>
                    <span>USDA Market News â€¢ MOSTLY Prices</span>
                </div>
            </div>
            <div class="season-badge">
                <span class="dot"></span>
                <span id="seasonLabel">Winter Season</span>
            </div>
        </header>
        
        <!-- Section Toggle -->
        <div class="section-toggle">
            <button class="section-btn active" data-section="vegetables">
                <span class="icon">ðŸ¥¬</span> Vegetables
            </button>
            <button class="section-btn" data-section="onions">
                <span class="icon">ðŸ§…</span> Onions
            </button>
        </div>
        
        <!-- Vegetable Tabs -->
        <div class="commodity-tabs" id="vegTabs">
            <button class="tab vegetable active" data-commodity="iceberg">Iceberg Lettuce</button>
            <button class="tab vegetable" data-commodity="romaine">Romaine Lettuce</button>
            <button class="tab vegetable" data-commodity="hearts">Romaine Hearts</button>
            <button class="tab vegetable" data-commodity="broccoli">Broccoli</button>
            <button class="tab vegetable" data-commodity="cauliflower">Cauliflower</button>
            <button class="tab vegetable" data-commodity="celery">Celery</button>
        </div>
        
        <!-- Onion Tabs -->
        <div class="commodity-tabs" id="onionTabs" style="display: none;">
            <button class="tab onion active" data-commodity="onion-yellow">Yellow Onions</button>
            <button class="tab onion" data-commodity="onion-white">White Onions</button>
            <button class="tab onion" data-commodity="onion-red">Red Onions</button>
        </div>
        
        <div class="main-layout">
            <div class="chart-section">
                <div class="chart-header">
                    <div class="price-display">
                        <h2>
                            <span id="commodityName">Iceberg Lettuce</span>
                            <span class="shipping-point" id="shippingPoint">Imperial Valley</span>
                        </h2>
                        <div class="price-row">
                            <span class="price-value" id="currentPrice">--</span>
                            <span class="price-change up" id="priceChange" style="display: none;">
                                <span>â†‘</span>
                                <span>$0.00 (0.0%)</span>
                            </span>
                        </div>
                        <div class="price-meta" id="priceMeta">Loading...</div>
                    </div>
                    <div class="time-controls">
                        <div class="time-range">
                            <button class="time-btn" data-days="30">30D</button>
                            <button class="time-btn active" data-days="60">60D</button>
                            <button class="time-btn" data-days="90">90D</button>
                            <button class="time-btn" data-days="180">6M</button>
                            <button class="time-btn" data-days="365">1Y</button>
                        </div>
                        <div class="region-toggle">
                            <span>Region:</span>
                            <select id="regionSelect">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            <div class="sidebar">
                <div class="sidebar-section-title">Vegetables</div>
                <div class="price-card vegetable active" data-commodity="iceberg" data-section="vegetables">
                    <div class="card-header">
                        <span class="card-title">Iceberg</span>
                        <span class="card-badge" id="badge-iceberg"></span>
                    </div>
                    <div class="card-price" id="price-iceberg">--</div>
                    <div class="card-range">24s cartons</div>
                    <canvas class="card-sparkline" id="spark-iceberg"></canvas>
                </div>
                <div class="price-card vegetable" data-commodity="romaine" data-section="vegetables">
                    <div class="card-header">
                        <span class="card-title">Romaine</span>
                        <span class="card-badge" id="badge-romaine"></span>
                    </div>
                    <div class="card-price" id="price-romaine">--</div>
                    <div class="card-range">24s cartons</div>
                    <canvas class="card-sparkline" id="spark-romaine"></canvas>
                </div>
                <div class="price-card vegetable" data-commodity="hearts" data-section="vegetables">
                    <div class="card-header">
                        <span class="card-title">Romaine Hearts</span>
                        <span class="card-badge" id="badge-hearts"></span>
                    </div>
                    <div class="card-price" id="price-hearts">--</div>
                    <div class="card-range">12 3-ct pkgs</div>
                    <canvas class="card-sparkline" id="spark-hearts"></canvas>
                </div>
                
                <div class="sidebar-section-title">Onions</div>
                <div class="price-card onion" data-commodity="onion-yellow" data-section="onions">
                    <div class="card-header">
                        <span class="card-title">Yellow</span>
                        <span class="card-badge" id="badge-onion-yellow"></span>
                    </div>
                    <div class="card-price" id="price-onion-yellow">--</div>
                    <div class="card-range">50 lb sacks jumbo</div>
                    <canvas class="card-sparkline" id="spark-onion-yellow"></canvas>
                </div>
                <div class="price-card onion" data-commodity="onion-white" data-section="onions">
                    <div class="card-header">
                        <span class="card-title">White</span>
                        <span class="card-badge" id="badge-onion-white"></span>
                    </div>
                    <div class="card-price" id="price-onion-white">--</div>
                    <div class="card-range">50 lb sacks jumbo</div>
                    <canvas class="card-sparkline" id="spark-onion-white"></canvas>
                </div>
                <div class="price-card onion" data-commodity="onion-red" data-section="onions">
                    <div class="card-header">
                        <span class="card-title">Red</span>
                        <span class="card-badge" id="badge-onion-red"></span>
                    </div>
                    <div class="card-price" id="price-onion-red">--</div>
                    <div class="card-range">25 lb sacks jumbo</div>
                    <canvas class="card-sparkline" id="spark-onion-red"></canvas>
                </div>
                
                <div class="market-stats">
                    <div class="stats-title">Market Overview</div>
                    <div class="stat-row">
                        <span class="stat-label">Period High</span>
                        <span class="stat-value" id="stat-high">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Period Low</span>
                        <span class="stat-value" id="stat-low">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Period Avg</span>
                        <span class="stat-value" id="stat-avg">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Demand</span>
                        <span class="stat-value" id="stat-demand">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Market</span>
                        <span class="stat-value" id="stat-trend">--</span>
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <div class="footer-text">
                Data: <a href="https://www.ams.usda.gov/mnreports/fvdfob.pdf" target="_blank">USDA AMS FOB Reports</a> â€¢ 
                MOSTLY price midpoints
            </div>
            <div class="footer-text">Last sync: <span id="lastSync">--</span></div>
        </footer>
    </div>
    <script>
        // Commodity definitions
        const VEGETABLES = {
            iceberg: { name: 'Iceberg Lettuce', color: '#3fb950', package: '24s cartons' },
            romaine: { name: 'Romaine Lettuce', color: '#58a6ff', package: '24s cartons' },
            hearts: { name: 'Romaine Hearts', color: '#a371f7', package: '12 3-ct pkgs' },
            broccoli: { name: 'Broccoli', color: '#3fb950', package: '14s bunched' },
            cauliflower: { name: 'Cauliflower', color: '#f0f6fc', package: '12s film wrapped' },
            celery: { name: 'Celery', color: '#7ee787', package: '2-3 dz cartons' }
        };
        
        const ONIONS = {
            'onion-yellow': { name: 'Yellow Onions', color: '#d29922', package: '50 lb sacks jumbo' },
            'onion-white': { name: 'White Onions', color: '#f0f6fc', package: '50 lb sacks jumbo' },
            'onion-red': { name: 'Red Onions', color: '#f85149', package: '25 lb sacks jumbo' }
        };
        
        const VEG_REGIONS = {
            salinas: { name: 'Salinas-Watsonville', season: [4, 5, 6, 7, 8, 9, 10, 11] },
            imperial: { name: 'Imperial/Coachella', season: [11, 12, 1, 2, 3, 4] },
            yuma: { name: 'Yuma', season: [11, 12, 1, 2, 3] },
            'santa-maria': { name: 'Santa Maria', season: [1,2,3,4,5,6,7,8,9,10,11,12] }
        };
        
        const ONION_REGIONS = {
            'idaho': { name: 'Idaho/Malheur Co. Oregon', season: [8, 9, 10, 11, 12, 1, 2, 3, 4] },
            'columbia-basin': { name: 'Columbia Basin WA/OR', season: [7, 8, 9, 10, 11, 12, 1, 2, 3, 4] },
            'wisconsin': { name: 'Central Wisconsin', season: [8, 9, 10, 11, 12, 1, 2] },
            'new-york': { name: 'New York', season: [8, 9, 10, 11, 12] },
            'texas': { name: 'Texas', season: [3, 4, 5, 6] },
            'georgia': { name: 'Georgia/Vidalia', season: [4, 5, 6] }
        };
        
        let state = {
            section: 'vegetables',
            commodity: 'iceberg',
            region: 'auto',
            days: 60,
            data: {}
        };
        
        let mainChart = null;
        let sparkCharts = {};
        
        function getCurrentVegSeason() {
            const month = new Date().getMonth() + 1;
            if ([11, 12, 1, 2, 3].includes(month)) {
                return { region: 'imperial', label: 'Winter â€¢ Imperial/Yuma' };
            }
            return { region: 'salinas', label: 'Summer â€¢ Salinas' };
        }
        
        function getCurrentOnionSeason() {
            const month = new Date().getMonth() + 1;
            if ([3, 4, 5, 6].includes(month)) {
                return { region: 'texas', label: 'Spring â€¢ Texas/Vidalia' };
            }
            return { region: 'idaho', label: 'Storage Season â€¢ Idaho/WA' };
        }
        
        function getActiveRegion() {
            if (state.region !== 'auto') return state.region;
            return state.section === 'vegetables' 
                ? getCurrentVegSeason().region 
                : getCurrentOnionSeason().region;
        }
        
        function getRegions() {
            return state.section === 'vegetables' ? VEG_REGIONS : ONION_REGIONS;
        }
        
        function getCommodities() {
            return state.section === 'vegetables' ? VEGETABLES : ONIONS;
        }
        
        function getCommodityColor() {
            const commodities = getCommodities();
            return commodities[state.commodity]?.color || '#3fb950';
        }
        
        // Sheet URL
       const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1vHq6C9kgA7TANUfR6VBzPVRn6Zr6PTjhawjKNy2pIsY/pub?gid=601485202&single=true&output=csv';
        
        async function fetchData() {
            if (!SHEET_CSV_URL) return {};
            try {
                const jsonUrl = SHEET_CSV_URL.replace('/pub?', '/gviz/tq?tqx=out:json&').replace('&output=csv', '');
                const response = await fetch(jsonUrl);
                const text = await response.text();
                const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?$/);
                if (jsonMatch) {
                    const json = JSON.parse(jsonMatch[1]);
                    return parseGoogleJSON(json);
                }
                return {};
            } catch (e) {
                console.error('Fetch failed:', e);
                return {};
            }
        }
        
        function parseGoogleJSON(json) {
            const data = { vegetables: {}, onions: {} };
            
            // Initialize vegetable structure
            Object.keys(VEGETABLES).forEach(c => {
                data.vegetables[c] = {};
                Object.keys(VEG_REGIONS).forEach(r => data.vegetables[c][r] = []);
            });
            
            // Initialize onion structure
            Object.keys(ONIONS).forEach(c => {
                data.onions[c] = {};
                Object.keys(ONION_REGIONS).forEach(r => data.onions[c][r] = []);
            });
            
            if (!json.table || !json.table.rows) return data;
            
            json.table.rows.forEach(row => {
                if (!row.c) return;
                const values = row.c.map(cell => cell ? (cell.v !== null ? cell.v : (cell.f || '')) : '');
                const [date, point, commodity, pkg, low, high, avg, market, demand] = values;
                if (!date || !commodity) return;
                
                // Parse date
                let dateStr = '';
                if (typeof date === 'string') {
                    const gDateMatch = date.match(/Date\((\d+),(\d+),(\d+)\)/);
                    if (gDateMatch) {
                        const year = gDateMatch[1];
                        const month = String(parseInt(gDateMatch[2]) + 1).padStart(2, '0');
                        const day = gDateMatch[3].padStart(2, '0');
                        dateStr = `${year}-${month}-${day}`;
                    } else if (date.includes('/')) {
                        const parts = date.split('/');
                        dateStr = `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
                    } else {
                        dateStr = date;
                    }
                } else if (typeof date === 'number') {
                    const d = new Date((date - 25569) * 86400 * 1000);
                    dateStr = d.toISOString().split('T')[0];
                }
                
                const upperComm = String(commodity).toUpperCase();
                const upperPkg = String(pkg).toUpperCase();
                const upperPoint = String(point).toUpperCase();
                
                // Check if it's an onion
                if (upperComm.includes('ONIONS, DRY')) {
                    let onionKey = null;
                    if (upperComm.includes('YELLOW')) onionKey = 'onion-yellow';
                    else if (upperComm.includes('WHITE')) onionKey = 'onion-white';
                    else if (upperComm.includes('RED')) onionKey = 'onion-red';
                    
                    let regionKey = null;
                    if (upperPoint.includes('IDAHO') || upperPoint.includes('MALHEUR')) regionKey = 'idaho';
                    else if (upperPoint.includes('COLUMBIA') || upperPoint.includes('WASHINGTON') || upperPoint.includes('UMATILLA')) regionKey = 'columbia-basin';
                    else if (upperPoint.includes('WISCONSIN')) regionKey = 'wisconsin';
                    else if (upperPoint.includes('NEW YORK')) regionKey = 'new-york';
                    else if (upperPoint.includes('TEXAS')) regionKey = 'texas';
                    else if (upperPoint.includes('GEORGIA') || upperPoint.includes('VIDALIA')) regionKey = 'georgia';
                    
                    if (onionKey && regionKey && data.onions[onionKey]?.[regionKey]) {
                        data.onions[onionKey][regionKey].push({
                            date: dateStr,
                            low: parseFloat(low) || 0,
                            high: parseFloat(high) || 0,
                            avg: parseFloat(avg) || 0,
                            demand: demand || '',
                            trend: market || ''
                        });
                    }
                } else {
                    // Vegetable
                    let vegKey = null;
                    if (upperComm.includes('ROMAINE') && upperPkg.includes('HEART')) vegKey = 'hearts';
                    else if (upperComm.includes('ICEBERG')) vegKey = 'iceberg';
                    else if (upperComm.includes('ROMAINE')) vegKey = 'romaine';
                    else if (upperComm.includes('BROCCOLI')) vegKey = 'broccoli';
                    else if (upperComm.includes('CAULIFLOWER')) vegKey = 'cauliflower';
                    else if (upperComm.includes('CELERY')) vegKey = 'celery';
                    
                    let regionKey = null;
                    if (upperPoint.includes('SALINAS') || upperPoint.includes('WATSONVILLE')) regionKey = 'salinas';
                    else if (upperPoint.includes('IMPERIAL') || upperPoint.includes('COACHELLA')) regionKey = 'imperial';
                    else if (upperPoint.includes('YUMA')) regionKey = 'yuma';
                    else if (upperPoint.includes('SANTA MARIA') || upperPoint.includes('OXNARD')) regionKey = 'santa-maria';
                    
                    if (vegKey && regionKey && data.vegetables[vegKey]?.[regionKey]) {
                        data.vegetables[vegKey][regionKey].push({
                            date: dateStr,
                            low: parseFloat(low) || 0,
                            high: parseFloat(high) || 0,
                            avg: parseFloat(avg) || 0,
                            demand: demand || '',
                            trend: market || ''
                        });
                    }
                }
            });
            
            // Dedupe and sort
            ['vegetables', 'onions'].forEach(section => {
                Object.keys(data[section]).forEach(c => {
                    Object.keys(data[section][c]).forEach(r => {
                        const byDate = {};
                        data[section][c][r].forEach(entry => {
                            if (!byDate[entry.date]) byDate[entry.date] = [];
                            byDate[entry.date].push(entry);
                        });
                        data[section][c][r] = Object.keys(byDate).sort().map(date => {
                            const entries = byDate[date];
                            return {
                                date,
                                low: Math.round(entries.reduce((s, e) => s + e.low, 0) / entries.length * 100) / 100,
                                high: Math.round(entries.reduce((s, e) => s + e.high, 0) / entries.length * 100) / 100,
                                avg: Math.round(entries.reduce((s, e) => s + e.avg, 0) / entries.length * 100) / 100,
                                demand: entries[0].demand,
                                trend: entries[0].trend
                            };
                        });
                    });
                });
            });
            
            return data;
        }
        
        function populateRegionDropdown() {
            const select = document.getElementById('regionSelect');
            const regions = getRegions();
            const season = state.section === 'vegetables' ? getCurrentVegSeason() : getCurrentOnionSeason();
            
            select.innerHTML = `<option value="auto">Auto (${season.label})</option>`;
            Object.entries(regions).forEach(([key, val]) => {
                select.innerHTML += `<option value="${key}">${val.name}</option>`;
            });
            select.value = state.region;
        }
        
        function renderMainChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const region = getActiveRegion();
            const sectionData = state.section === 'vegetables' ? state.data.vegetables : state.data.onions;
            const commodityData = sectionData?.[state.commodity]?.[region] || [];
            
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - state.days);
            const filtered = commodityData.filter(d => new Date(d.date) >= cutoff);
            
            if (mainChart) mainChart.destroy();
            
            if (filtered.length === 0) {
                mainChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        scales: { x: { display: false }, y: { display: false } }
                    }
                });
                return;
            }
            
            const color = getCommodityColor();
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, color + '40');
            gradient.addColorStop(1, color + '00');
            
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filtered.map(d => d.date),
                    datasets: [
                        {
                            label: 'Mostly Avg',
                            data: filtered.map(d => d.avg),
                            borderColor: color,
                            backgroundColor: gradient,
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0.35,
                            pointRadius: filtered.length === 1 ? 6 : 0,
                            pointHoverRadius: 6,
                            pointBackgroundColor: color
                        },
                        {
                            label: 'Mostly High',
                            data: filtered.map(d => d.high),
                            borderColor: 'rgba(139, 148, 158, 0.4)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.35,
                            pointRadius: 0
                        },
                        {
                            label: 'Mostly Low',
                            data: filtered.map(d => d.low),
                            borderColor: 'rgba(139, 148, 158, 0.4)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.35,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#f0f6fc',
                            bodyColor: '#8b949e',
                            borderColor: '#30363d',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                            title: (items) => {     const d = new Date(items[0].label + 'T00:00:00');     return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }); },),
                                label: (item) => {
                                    const labels = ['Avg', 'High', 'Low'];
                                    return `${labels[item.datasetIndex]}: $${item.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: state.days <= 60 ? 'week' : 'month', displayFormats: { week: 'MMM d', month: 'MMM' } },
                            grid: { color: 'rgba(48, 54, 61, 0.5)', drawBorder: false },
                            ticks: { color: '#6e7681', maxTicksLimit: 8 }
                        },
                        y: {
                            position: 'right',
                            grid: { color: 'rgba(48, 54, 61, 0.5)', drawBorder: false },
                            ticks: { color: '#6e7681', callback: v => '$' + v }
                        }
                    }
                }
            });
        }
        
        function renderSparkline(id, dataArr, color) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            const recent = dataArr.slice(-30);
            if (sparkCharts[id]) sparkCharts[id].destroy();
            
            if (recent.length === 0) {
                sparkCharts[id] = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                return;
            }
            
            sparkCharts[id] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recent.map(d => d.date),
                    datasets: [{
                        data: recent.map(d => d.avg),
                        borderColor: color,
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.4,
                        pointRadius: recent.length === 1 ? 3 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }
        
        function updateUI() {
            const region = getActiveRegion();
            const regions = getRegions();
            const commodities = getCommodities();
            const sectionData = state.section === 'vegetables' ? state.data.vegetables : state.data.onions;
            const dataArr = sectionData?.[state.commodity]?.[region] || [];
            const latest = dataArr[dataArr.length - 1];
            const prev = dataArr[dataArr.length - 2];
            
            document.getElementById('commodityName').textContent = commodities[state.commodity]?.name || state.commodity;
            document.getElementById('shippingPoint').textContent = regions[region]?.name || region;
            
            const priceEl = document.getElementById('currentPrice');
            const changeEl = document.getElementById('priceChange');
            const metaEl = document.getElementById('priceMeta');
            
            if (latest) {
                priceEl.textContent = `$${latest.avg.toFixed(2)}`;
                priceEl.className = 'price-value';
                
                if (prev) {
                    const change = latest.avg - prev.avg;
                    const pct = (change / prev.avg) * 100;
                    changeEl.style.display = 'inline-flex';
                    changeEl.className = 'price-change ' + (change > 0.01 ? 'up' : change < -0.01 ? 'down' : 'flat');
                    const arrow = change > 0.01 ? 'â†‘' : change < -0.01 ? 'â†“' : 'â†’';
                    changeEl.innerHTML = `<span>${arrow}</span><span>$${Math.abs(change).toFixed(2)} (${Math.abs(pct).toFixed(1)}%)</span>`;
                } else {
                    changeEl.style.display = 'none';
                }
                
                metaEl.textContent = `Mostly: $${latest.low.toFixed(2)} - $${latest.high.toFixed(2)}` +
                    (latest.demand ? ` â€¢ ${latest.demand} demand` : '') +
                    (latest.trend ? ` â€¢ ${latest.trend}` : '');
                
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - state.days);
                const period = dataArr.filter(d => new Date(d.date) >= cutoff);
                
                if (period.length > 0) {
                    document.getElementById('stat-high').textContent = `$${Math.max(...period.map(d => d.high)).toFixed(2)}`;
                    document.getElementById('stat-low').textContent = `$${Math.min(...period.map(d => d.low)).toFixed(2)}`;
                    document.getElementById('stat-avg').textContent = `$${(period.reduce((s, d) => s + d.avg, 0) / period.length).toFixed(2)}`;
                    document.getElementById('stat-demand').textContent = latest.demand || '--';
                    document.getElementById('stat-trend').textContent = latest.trend || '--';
                }
            } else {
                priceEl.textContent = 'No data';
                priceEl.className = 'price-value no-data';
                changeEl.style.display = 'none';
                metaEl.textContent = `No data available for ${regions[region]?.name || region}`;
                document.getElementById('stat-high').textContent = '--';
                document.getElementById('stat-low').textContent = '--';
                document.getElementById('stat-avg').textContent = '--';
                document.getElementById('stat-demand').textContent = '--';
                document.getElementById('stat-trend').textContent = '--';
            }
            
            // Update season label
            const vegSeason = getCurrentVegSeason();
            const onionSeason = getCurrentOnionSeason();
            document.getElementById('seasonLabel').textContent = state.section === 'vegetables' ? vegSeason.label : onionSeason.label;
            document.getElementById('lastSync').textContent = new Date().toLocaleString();
            
            renderMainChart();
        }
        
        function updateAllCards() {
            // Update vegetable cards
            const vegRegion = state.section === 'vegetables' ? getActiveRegion() : getCurrentVegSeason().region;
            ['iceberg', 'romaine', 'hearts'].forEach(c => {
                const dataArr = state.data.vegetables?.[c]?.[vegRegion] || [];
                const latest = dataArr[dataArr.length - 1];
                const prev = dataArr[dataArr.length - 2];
                
                const priceEl = document.getElementById(`price-${c}`);
                const badgeEl = document.getElementById(`badge-${c}`);
                
                if (latest) {
                    if (priceEl) priceEl.textContent = `$${latest.avg.toFixed(2)}`;
                    if (badgeEl && prev) {
                        const change = ((latest.avg - prev.avg) / prev.avg) * 100;
                        badgeEl.style.display = 'inline-block';
                        badgeEl.className = 'card-badge ' + (change > 0.1 ? 'up' : change < -0.1 ? 'down' : 'flat');
                        badgeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`;
                    } else if (badgeEl) {
                        badgeEl.style.display = 'none';
                    }
                } else {
                    if (priceEl) priceEl.textContent = '--';
                    if (badgeEl) badgeEl.style.display = 'none';
                }
                
                renderSparkline(`spark-${c}`, dataArr, VEGETABLES[c].color);
            });
            
            // Update onion cards
            const onionRegion = state.section === 'onions' ? getActiveRegion() : getCurrentOnionSeason().region;
            ['onion-yellow', 'onion-white', 'onion-red'].forEach(c => {
                const dataArr = state.data.onions?.[c]?.[onionRegion] || [];
                const latest = dataArr[dataArr.length - 1];
                const prev = dataArr[dataArr.length - 2];
                
                const priceEl = document.getElementById(`price-${c}`);
                const badgeEl = document.getElementById(`badge-${c}`);
                
                if (latest) {
                    if (priceEl) priceEl.textContent = `$${latest.avg.toFixed(2)}`;
                    if (badgeEl && prev) {
                        const change = ((latest.avg - prev.avg) / prev.avg) * 100;
                        badgeEl.style.display = 'inline-block';
                        badgeEl.className = 'card-badge ' + (change > 0.1 ? 'up' : change < -0.1 ? 'down' : 'flat');
                        badgeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`;
                    } else if (badgeEl) {
                        badgeEl.style.display = 'none';
                    }
                } else {
                    if (priceEl) priceEl.textContent = '--';
                    if (badgeEl) badgeEl.style.display = 'none';
                }
                
                renderSparkline(`spark-${c}`, dataArr, ONIONS[c].color);
            });
        }
        
        function switchSection(section) {
            state.section = section;
            state.region = 'auto';
            
            // Update default commodity for section
            if (section === 'vegetables') {
                state.commodity = 'iceberg';
            } else {
                state.commodity = 'onion-yellow';
            }
            
            // Toggle tabs visibility
            document.getElementById('vegTabs').style.display = section === 'vegetables' ? 'flex' : 'none';
            document.getElementById('onionTabs').style.display = section === 'onions' ? 'flex' : 'none';
            
            // Update section buttons
            document.querySelectorAll('.section-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === section);
            });
            
            // Update active tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-commodity="${state.commodity}"]`)?.classList.add('active');
            
            // Update active cards
            document.querySelectorAll('.price-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`.price-card[data-commodity="${state.commodity}"]`)?.classList.add('active');
            
            populateRegionDropdown();
            updateUI();
            updateAllCards();
        }
        
        function setupEvents() {
            // Section toggle
            document.querySelectorAll('.section-btn').forEach(btn => {
                btn.addEventListener('click', () => switchSection(btn.dataset.section));
            });
            
            // Vegetable tabs
            document.querySelectorAll('#vegTabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('#vegTabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.commodity = tab.dataset.commodity;
                    
                    document.querySelectorAll('.price-card').forEach(c => c.classList.remove('active'));
                    document.querySelector(`.price-card[data-commodity="${state.commodity}"]`)?.classList.add('active');
                    
                    updateUI();
                });
            });
            
            // Onion tabs
            document.querySelectorAll('#onionTabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('#onionTabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.commodity = tab.dataset.commodity;
                    
                    document.querySelectorAll('.price-card').forEach(c => c.classList.remove('active'));
                    document.querySelector(`.price-card[data-commodity="${state.commodity}"]`)?.classList.add('active');
                    
                    updateUI();
                });
            });
            
            // Sidebar cards
            document.querySelectorAll('.price-card').forEach(card => {
                card.addEventListener('click', () => {
                    const section = card.dataset.section;
                    const commodity = card.dataset.commodity;
                    
                    if (state.section !== section) {
                        switchSection(section);
                    }
                    
                    state.commodity = commodity;
                    
                    // Update tabs
                    const tabContainer = section === 'vegetables' ? '#vegTabs' : '#onionTabs';
                    document.querySelectorAll(`${tabContainer} .tab`).forEach(t => t.classList.remove('active'));
                    document.querySelector(`${tabContainer} .tab[data-commodity="${commodity}"]`)?.classList.add('active');
                    
                    // Update cards
                    document.querySelectorAll('.price-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    
                    updateUI();
                });
            });
            
            // Time range buttons
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.days = parseInt(btn.dataset.days);
                    updateUI();
                });
            });
            
            // Region dropdown
            document.getElementById('regionSelect').addEventListener('change', e => {
                state.region = e.target.value;
                updateUI();
                updateAllCards();
            });
        }
        
        async function init() {
            state.data = await fetchData();
            console.log('Loaded data:', state.data);
            populateRegionDropdown();
            setupEvents();
            updateUI();
            updateAllCards();
        }
        
        init();
    </script>
</body>
</html>
