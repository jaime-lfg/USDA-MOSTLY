<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>USDA FOB Produce Prices</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-card: #21262d;
      --bg-hover: #30363d;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --green: #3fb950;
      --green-dim: rgba(63, 185, 80, 0.15);
      --red: #f85149;
      --red-dim: rgba(248, 81, 73, 0.15);
      --blue: #58a6ff;
      --blue-dim: rgba(88, 166, 255, 0.15);
      --border: #30363d;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding-bottom: 20px; border-bottom: 1px solid var(--border);
      margin-bottom: 24px; flex-wrap: wrap; gap: 16px;
    }
    .logo { display:flex; align-items:center; gap:12px; }
    .logo-icon { font-size:32px; }
    .logo-text h1 { font-size:1.4rem; font-weight:600; }
    .logo-text span { color:var(--text-muted); font-size:.8rem; }
    .season-badge {
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px; background:var(--blue-dim);
      border:1px solid var(--blue); border-radius:20px;
      font-size:.75rem; color:var(--blue); font-weight:500;
    }
    .season-badge .dot { width:8px;height:8px;background:var(--blue);border-radius:50%;animation:pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity:1 } 50% { opacity:.5 } }

    .commodity-tabs { display:flex; gap:6px; margin-bottom:24px; flex-wrap:wrap; }
    .tab {
      padding:10px 18px; background:var(--bg-secondary);
      border:1px solid var(--border); border-radius:8px;
      color:var(--text-secondary); font-size:.85rem; font-weight:500;
      cursor:pointer; transition:all .15s;
    }
    .tab:hover { background:var(--bg-hover); color:var(--text-primary); }
    .tab.active { background:var(--green-dim); border-color:var(--green); color:var(--green); }

    .main-layout { display:grid; grid-template-columns: 1fr 300px; gap:24px; }
    @media (max-width:1024px){ .main-layout { grid-template-columns:1fr; } }

    .chart-section { background:var(--bg-secondary); border:1px solid var(--border); border-radius:12px; padding:24px; }
    .chart-header { display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap; margin-bottom:24px; }

    .price-display h2 {
      font-size:.9rem; font-weight:500; color:var(--text-secondary);
      margin-bottom:8px; display:flex; align-items:center; gap:8px;
    }
    .shipping-point { font-size:.75rem; padding:3px 8px; background:var(--bg-hover); border-radius:4px; color:var(--text-muted); }

    .price-row { display:flex; align-items:baseline; gap:16px; flex-wrap:wrap; }
    .price-value { font-size:2.8rem; font-weight:700; letter-spacing:-2px; }

    .price-change {
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:6px;
      font-size:.9rem; font-weight:600;
    }
    .price-change.up { background:var(--green-dim); color:var(--green); }
    .price-change.down { background:var(--red-dim); color:var(--red); }
    .price-change.flat { background:var(--bg-hover); color:var(--text-secondary); }
    .price-meta { color:var(--text-muted); font-size:.8rem; margin-top:6px; }

    .time-controls { display:flex; flex-direction:column; align-items:flex-end; gap:10px; }
    .time-range { display:flex; background:var(--bg-card); border-radius:8px; padding:3px; gap:2px; }
    .time-btn {
      padding:6px 14px; background:transparent; border:none; border-radius:6px;
      color:var(--text-secondary); font-size:.8rem; font-weight:500;
      cursor:pointer; transition:all .15s;
    }
    .time-btn:hover { color:var(--text-primary); background:var(--bg-hover); }
    .time-btn.active { background:var(--bg-hover); color:var(--text-primary); }

    .region-toggle { display:flex; align-items:center; gap:8px; font-size:.75rem; color:var(--text-muted); }
    .region-toggle select {
      background:var(--bg-card); border:1px solid var(--border); border-radius:6px;
      padding:4px 8px; color:var(--text-primary); font-size:.75rem; cursor:pointer;
    }

    .chart-container { position:relative; height:420px; margin-top:16px; }
    .no-data {
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      text-align:center; color:var(--text-muted); padding:24px;
    }
    .no-data.show { display:flex; }

    .sidebar { display:flex; flex-direction:column; gap:16px; }
    .price-card {
      background:var(--bg-secondary); border:1px solid var(--border);
      border-radius:10px; padding:16px; cursor:pointer; transition:all .15s;
    }
    .price-card:hover { border-color:var(--text-muted); transform:translateY(-1px); }
    .price-card.active { border-color:var(--green); background:linear-gradient(135deg,var(--green-dim),transparent); }

    .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .card-title { font-size:.85rem; font-weight:600; }
    .card-badge { font-size:.7rem; padding:2px 6px; border-radius:4px; font-weight:500; }
    .card-badge.up { background:var(--green-dim); color:var(--green); }
    .card-badge.down { background:var(--red-dim); color:var(--red); }
    .card-badge.flat { background:var(--bg-hover); color:var(--text-muted); }

    .card-price { font-size:1.5rem; font-weight:700; margin-bottom:4px; }
    .card-range { font-size:.75rem; color:var(--text-muted); }
    .card-sparkline { height:40px; margin-top:12px; }

    footer {
      margin-top:32px; padding-top:20px; border-top:1px solid var(--border);
      display:flex; justify-content:space-between; flex-wrap:wrap; gap:12px;
    }
    .footer-text { font-size:.75rem; color:var(--text-muted); }
    .footer-text a { color:var(--blue); text-decoration:none; }

    /* tiny debug footer */
    .debug { color: var(--text-muted); font-size: 12px; margin-top: 8px; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="logo">
        <span class="logo-icon">ü•¨</span>
        <div class="logo-text">
          <h1>FOB Produce Prices</h1>
          <span>USDA Market News ‚Ä¢ MOSTLY Avg</span>
        </div>
      </div>
      <div class="season-badge">
        <span class="dot"></span>
        <span id="seasonLabel">‚Äî</span>
      </div>
    </header>

    <div class="commodity-tabs">
      <button class="tab active" data-commodity="iceberg">Iceberg Lettuce</button>
      <button class="tab" data-commodity="romaine">Romaine Lettuce</button>
      <button class="tab" data-commodity="hearts">Romaine Hearts</button>
      <button class="tab" data-commodity="broccoli">Broccoli</button>
      <button class="tab" data-commodity="cauliflower">Cauliflower</button>
      <button class="tab" data-commodity="celery">Celery</button>
    </div>

    <div class="main-layout">
      <div class="chart-section">
        <div class="chart-header">
          <div class="price-display">
            <h2>
              <span id="commodityName">Iceberg Lettuce</span>
              <span class="shipping-point" id="shippingPoint">‚Äî</span>
            </h2>
            <div class="price-row">
              <span class="price-value" id="currentPrice">‚Äî</span>
              <span class="price-change flat" id="priceChange"><span>‚Üí</span><span>‚Äî</span></span>
            </div>
            <div class="price-meta" id="priceMeta">Waiting for data‚Ä¶</div>
            <div class="debug" id="debugLine">Loading‚Ä¶</div>
          </div>

          <div class="time-controls">
            <div class="time-range">
              <button class="time-btn" data-days="30">30D</button>
              <button class="time-btn active" data-days="60">60D</button>
              <button class="time-btn" data-days="90">90D</button>
              <button class="time-btn" data-days="180">6M</button>
              <button class="time-btn" data-days="365">1Y</button>
            </div>
            <div class="region-toggle">
              <span>Region:</span>
              <select id="regionSelect">
                <option value="auto">Auto (Smart)</option>
                <option value="salinas">Salinas</option>
                <option value="imperial">Imperial/Coachella</option>
                <option value="yuma">Yuma</option>
                <option value="santa-maria">Santa Maria</option>
              </select>
            </div>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="mainChart"></canvas>
          <div id="noDataOverlay" class="no-data">
            No matching rows found for this commodity/region yet.<br/>
            (Or the published History tab has no rows.)
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="price-card active" data-commodity="iceberg">
          <div class="card-header">
            <span class="card-title">Iceberg</span>
            <span class="card-badge flat" id="badge-iceberg">‚Äî</span>
          </div>
          <div class="card-price" id="price-iceberg">‚Äî</div>
          <div class="card-range">Mostly Avg</div>
          <canvas class="card-sparkline" id="spark-iceberg"></canvas>
        </div>

        <div class="price-card" data-commodity="romaine">
          <div class="card-header">
            <span class="card-title">Romaine</span>
            <span class="card-badge flat" id="badge-romaine">‚Äî</span>
          </div>
          <div class="card-price" id="price-romaine">‚Äî</div>
          <div class="card-range">Mostly Avg</div>
          <canvas class="card-sparkline" id="spark-romaine"></canvas>
        </div>

        <div class="price-card" data-commodity="hearts">
          <div class="card-header">
            <span class="card-title">Romaine Hearts</span>
            <span class="card-badge flat" id="badge-hearts">‚Äî</span>
          </div>
          <div class="card-price" id="price-hearts">‚Äî</div>
          <div class="card-range">Mostly Avg</div>
          <canvas class="card-sparkline" id="spark-hearts"></canvas>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-text">
        Data: <a href="https://www.ams.usda.gov/mnreports/fvdfob.pdf" target="_blank" rel="noreferrer">USDA AMS National FOB Review</a> ‚Ä¢
        Using ‚ÄúMostly Avg‚Äù
      </div>
      <div class="footer-text">Last sync: <span id="lastSync">--</span></div>
    </footer>
  </div>

  <script>
    // ======= EDIT THESE 2 IF NEEDED =======
    const PUBLISHED_DOC_ID = '2PACX-1vQVa4C--Jhg96w7_A0vqkTJouxLCvHOn2AT49foGzmdjcvU9DIn9a0QoEADzQ6SCDmqmuHNRZcJVmgm';
    const DEFAULT_GID = 1273956115; // <-- MUST be the History tab gid you published
    // =====================================

    const COMMODITIES = {
      iceberg:    { name: 'Iceberg Lettuce', color: '#3fb950' },
      romaine:    { name: 'Romaine Lettuce', color: '#58a6ff' },
      hearts:     { name: 'Romaine Hearts',  color: '#a371f7' },
      broccoli:   { name: 'Broccoli',        color: '#3fb950' },
      cauliflower:{ name: 'Cauliflower',     color: '#f0f6fc' },
      celery:     { name: 'Celery',          color: '#7ee787' }
    };

    const REGIONS = {
      salinas:       { name: 'Salinas-Watsonville' },
      imperial:      { name: 'Imperial/Coachella' },
      yuma:          { name: 'Yuma' },
      'santa-maria': { name: 'Santa Maria' }
    };

    let state = { commodity: 'iceberg', region: 'auto', days: 60, data: {} };
    let mainChart = null;
    const sparkCharts = {};

    function debug(msg) {
      const el = document.getElementById('debugLine');
      if (el) el.textContent = msg;
      console.log(msg);
    }

    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function getCurrentSeason() {
      const month = new Date().getMonth() + 1;
      if ([11,12,1,2,3].includes(month)) return { region: 'imperial', label: 'Winter Season ‚Ä¢ Imperial/Yuma' };
      return { region: 'salinas', label: 'Summer Season ‚Ä¢ Salinas' };
    }

    function getActiveRegion() {
      if (state.region !== 'auto') return state.region;

      const preferred = getCurrentSeason().region;
      const cd = state.data[state.commodity] || {};
      if (cd[preferred]?.length) return preferred;

      for (const r of Object.keys(cd)) {
        if (cd[r]?.length) return r;
      }
      return preferred;
    }

    function showNoData(show) {
      document.getElementById('noDataOverlay')?.classList.toggle('show', !!show);
    }

    function normalizeDateToISO(s) {
      if (!s) return null;
      const str = String(s).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
      if (str.includes('/')) {
        const [m,d,y] = str.split('/');
        if (m && d && y) return `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      }
      const dt = new Date(str);
      if (!Number.isNaN(dt.getTime())) return dt.toISOString().slice(0,10);
      return null;
    }

    function mapCommodityKey(commodity, pkg) {
      const c = String(commodity||'').toUpperCase().trim();
      const p = String(pkg||'').toUpperCase();
      if (c === 'LETTUCE, ICEBERG' || c.includes('ICEBERG')) return 'iceberg';
      if (c.includes('ROMAINE') && p.includes('HEART')) return 'hearts';
      if (c.includes('ROMAINE')) return 'romaine';
      if (c.includes('BROCCOLI')) return 'broccoli';
      if (c.includes('CAULIFLOWER')) return 'cauliflower';
      if (c.includes('CELERY')) return 'celery';
      return null;
    }

    function mapRegionKey(shippingPoint) {
      const sp = String(shippingPoint||'').toUpperCase();
      if (sp.includes('SALINAS') || sp.includes('WATSONVILLE')) return 'salinas';
      if (sp.includes('IMPERIAL') || sp.includes('COACHELLA')) return 'imperial';
      if (sp.includes('YUMA')) return 'yuma';
      if (sp.includes('SANTA MARIA') || sp.includes('OXNARD')) return 'santa-maria';
      return null;
    }

    // === CORS-PROOF SHEET LOAD (GVIZ via script tag) ===
    function gvizUrl(gid) {
      // cachebust ensures you don‚Äôt fight publish caching
      return `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_DOC_ID}/gviz/tq?gid=${encodeURIComponent(gid)}&tqx=out:json&cachebust=${Date.now()}`;
    }

    function loadGviz(gid) {
      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => reject(new Error('GViz load timeout')), 12000);

        // Intercept the GViz response call
        window.google = window.google || {};
        window.google.visualization = window.google.visualization || {};
        window.google.visualization.Query = window.google.visualization.Query || {};
        window.google.visualization.Query.setResponse = (resp) => {
          clearTimeout(timeout);
          resolve(resp);
        };

        const s = document.createElement('script');
        s.src = gvizUrl(gid);
        s.async = true;
        s.onerror = () => {
          clearTimeout(timeout);
          reject(new Error('GViz script failed to load'));
        };
        document.head.appendChild(s);
      });
    }

    function gvizTableToData(resp) {
      const out = {};
      for (const c of Object.keys(COMMODITIES)) {
        out[c] = {};
        for (const r of Object.keys(REGIONS)) out[c][r] = [];
      }

      const table = resp?.table;
      const cols = table?.cols || [];
      const rows = table?.rows || [];
      if (!cols.length || !rows.length) return out;

      const header = cols.map(c => String(c.label || '').trim().toLowerCase());
      const idx = (name) => header.indexOf(String(name).toLowerCase());

      const iDate = idx('date');
      const iComm = idx('commodity');
      const iPoint = idx('shipping point');
      const iPkg = idx('package');
      const iAvg = idx('mostly avg');
      const iMarket = idx('market');
      const iDemand = idx('demand');
      const iTrend = idx('trend'); // some sheets call it Trend

      if (iDate === -1 || iComm === -1 || iPoint === -1 || iAvg === -1) return out;

      for (const r of rows) {
        const cells = r.c || [];
        const get = (i) => (cells[i] ? (cells[i].v ?? cells[i].f ?? '') : '');

        const dateISO = normalizeDateToISO(get(iDate));
        const commodity = get(iComm);
        const point = get(iPoint);
        const pkg = iPkg !== -1 ? get(iPkg) : '';

        const commodityKey = mapCommodityKey(commodity, pkg);
        const regionKey = mapRegionKey(point);
        const avg = Number(get(iAvg));

        if (!dateISO || !commodityKey || !regionKey || !Number.isFinite(avg) || avg <= 0) continue;

        const trend = (iMarket !== -1 ? String(get(iMarket)||'') : '') || (iTrend !== -1 ? String(get(iTrend)||'') : '');
        const demand = iDemand !== -1 ? String(get(iDemand)||'') : '';

        out[commodityKey][regionKey].push({
          date: dateISO,
          avg,
          trend: String(trend).trim(),
          demand: String(demand).trim()
        });
      }

      for (const c of Object.keys(out)) {
        for (const r of Object.keys(out[c])) {
          out[c][r].sort((a,b) => new Date(a.date) - new Date(b.date));
        }
      }
      return out;
    }

    async function fetchData() {
      const gid = getParam('gid') || DEFAULT_GID;
      debug(`Loading History via GViz‚Ä¶ gid=${gid}`);
      const resp = await loadGviz(gid);
      const data = gvizTableToData(resp);
      const totalRows = Object.values(data).flatMap(x => Object.values(x)).reduce((s,arr)=>s+arr.length,0);
      debug(`Loaded rows: ${totalRows}`);
      return data;
    }

    function renderMainChart() {
      const ctx = document.getElementById('mainChart').getContext('2d');
      const region = getActiveRegion();
      const series = state.data[state.commodity]?.[region] || [];

      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - state.days);
      const filtered = series.filter(d => new Date(d.date) >= cutoff);

      if (mainChart) mainChart.destroy();

      if (!filtered.length) {
        showNoData(true);
        return;
      }
      showNoData(false);

      const color = COMMODITIES[state.commodity].color;

      mainChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: filtered.map(d => d.date),
          datasets: [{
            label: 'Mostly Avg',
            data: filtered.map(d => d.avg),
            borderColor: color,
            borderWidth: 2.5,
            fill: false,
            tension: 0.35,
            pointRadius: filtered.length === 1 ? 4 : 0,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { type: 'time' },
            y: { position: 'right', ticks: { callback: v => '$' + v } }
          }
        }
      });
    }

    function updateUI() {
      const region = getActiveRegion();
      const data = state.data[state.commodity]?.[region] || [];
      const latest = data[data.length - 1];
      const prev = data[data.length - 2];

      document.getElementById('commodityName').textContent = COMMODITIES[state.commodity].name;
      document.getElementById('shippingPoint').textContent = REGIONS[region]?.name || region;
      document.getElementById('seasonLabel').textContent = getCurrentSeason().label;
      document.getElementById('lastSync').textContent = new Date().toLocaleString();

      if (!latest) {
        document.getElementById('currentPrice').textContent = '‚Äî';
        document.getElementById('priceMeta').textContent = 'No matching rows yet';
        const changeEl = document.getElementById('priceChange');
        changeEl.className = 'price-change flat';
        changeEl.innerHTML = `<span>‚Üí</span><span>‚Äî</span>`;
        renderMainChart();
        return;
      }

      document.getElementById('currentPrice').textContent = `$${latest.avg.toFixed(2)}`;

      const changeEl = document.getElementById('priceChange');
      if (!prev) {
        changeEl.className = 'price-change flat';
        changeEl.innerHTML = `<span>‚Üí</span><span>‚Äî</span>`;
      } else {
        const change = latest.avg - prev.avg;
        const pct = (change / prev.avg) * 100;
        changeEl.className = 'price-change ' + (change > 0.01 ? 'up' : change < -0.01 ? 'down' : 'flat');
        const arrow = change > 0.01 ? '‚Üë' : change < -0.01 ? '‚Üì' : '‚Üí';
        changeEl.innerHTML = `<span>${arrow}</span><span>$${Math.abs(change).toFixed(2)} (${Math.abs(pct).toFixed(1)}%)</span>`;
      }

      const bits = [];
      if (latest.demand) bits.push(`${latest.demand} demand`);
      if (latest.trend) bits.push(latest.trend);
      bits.push(`Updated ${new Date(latest.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`);
      document.getElementById('priceMeta').textContent = bits.join(' ‚Ä¢ ');

      renderMainChart();
    }

    function setupEvents() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          state.commodity = tab.dataset.commodity;
          updateUI();
        });
      });

      document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.days = parseInt(btn.dataset.days, 10);
          updateUI();
        });
      });

      document.getElementById('regionSelect').addEventListener('change', e => {
        state.region = e.target.value;
        updateUI();
      });
    }

    async function init() {
      setupEvents();
      state.data = await fetchData();

      // quick sanity: if auto region has nothing, still show some region if any exists
      updateUI();
    }

    init();
  </script>
</body>
</html>
